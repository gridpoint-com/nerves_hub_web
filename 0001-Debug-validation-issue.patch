From 89abc7b0590c745a1639f7a5fd392358bda370f9 Mon Sep 17 00:00:00 2001
From: abelino <abelino.romo@gmail.com>
Date: Fri, 16 Jun 2023 00:38:48 -0700
Subject: [PATCH] Debug validation issue

---
 .../lib/nerves_hub_web_core/firmwares.ex        | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/apps/nerves_hub_web_core/lib/nerves_hub_web_core/firmwares.ex b/apps/nerves_hub_web_core/lib/nerves_hub_web_core/firmwares.ex
index a4ec5251..e3120f85 100644
--- a/apps/nerves_hub_web_core/lib/nerves_hub_web_core/firmwares.ex
+++ b/apps/nerves_hub_web_core/lib/nerves_hub_web_core/firmwares.ex
@@ -110,6 +110,16 @@ defmodule NervesHubWebCore.Firmwares do
   def create_firmware(org, filepath, params \\ %{}, opts \\ []) do
     upload_file_2 = opts[:upload_file_2] || (&@uploader.upload_file/2)
 
+    sha256sum =
+      File.stream!(filepath, [], 2048)
+      |> Enum.reduce(:crypto.hash_init(:sha256), fn (chunk, acc) ->
+        :crypto.hash_update(acc, chunk)
+      end)
+      |> :crypto.hash_final()
+      |> Base.encode16()
+
+    Logger.debug("filepath: #{inspect(filepath)} sha256sum: #{inspect(sha256sum)}")
+
     Repo.transaction(
       fn ->
         with {:ok, params} <- build_firmware_params(org, filepath, params),
@@ -157,13 +167,16 @@ defmodule NervesHubWebCore.Firmwares do
   def verify_signature(_filepath, []), do: {:error, :no_public_keys}
 
   def verify_signature(filepath, keys) when is_binary(filepath) do
+    Logger.debug("Attempting to verify #{inspect(filepath)} w/ key #{inspect(key)}")
+
     keys
     |> Enum.find(fn %{key: key} ->
       case System.cmd("fwup", ["--verify", "--public-key", key, "-i", filepath]) do
         {_, 0} ->
           true
 
-        _ ->
+        error ->
+          Logger.error("Validation failed #{inspect(error)}")
           false
       end
     end)
@@ -429,6 +442,8 @@ defmodule NervesHubWebCore.Firmwares do
   defp build_firmware_params(%{id: org_id} = org, filepath, params) do
     org = NervesHubWebCore.Repo.preload(org, :org_keys)
 
+    Logger.debug("keys: #{inspect(org.org_keys)}")
+
     with {:ok, %{id: org_key_id}} <- verify_signature(filepath, org.org_keys),
          {:ok, metadata} <- metadata_from_fwup(filepath) do
       filename = metadata.uuid <> ".fw"
-- 
2.41.0

